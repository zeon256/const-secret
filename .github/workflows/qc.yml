name: Quality Checks

on:
  push:
    branches: [main]
  pull_request:

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: 1.93.1
      - name: Format Check
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: 1.93.1
      - name: Clippy
        run: cargo clippy -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: 1.93.1
      - name: Test
        run: cargo test

  build-examples-release:
    name: Build Examples (Release)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: 1.93.1
      - name: Build Examples (Release)
        run: cargo build --example debug_drop --release
      - name: Upload Release Binary
        uses: actions/upload-artifact@v4
        with:
          name: debug_drop-release
          path: target/release/examples/debug_drop

  verify-binary-encryption:
    name: Verify Binary Encryption
    runs-on: ubuntu-latest
    needs: build-examples-release
    steps:
      - uses: actions/checkout@v4
      - name: Download Release Binary
        uses: actions/download-artifact@v4
        with:
          name: debug_drop-release
          path: target/release/examples
      - name: Make Binary Executable
        run: chmod +x target/release/examples/debug_drop
      - name: Verify Binary Encryption (objdump check)
        run: |
          # Verify the binary was built
          if [ ! -f target/release/examples/debug_drop ]; then
            echo "Error: Release binary not found"
            exit 1
          fi
          
          # Check for expected encryption patterns in assembly
          echo "Checking for encryption patterns in binary..."
          
          # Check for cmpxchg (atomic guard)
          if objdump -d target/release/examples/debug_drop | grep -q "cmpxchg"; then
            echo "✓ Found cmpxchg (atomic guard)"
          else
            echo "⚠ cmpxchg not found (may use different atomic pattern)"
          fi
          
          # Check for XOR operations
          XOR_COUNT=$(objdump -d target/release/examples/debug_drop | grep -c "xorl\|xorb\|xorps" || true)
          if [ "$XOR_COUNT" -gt 0 ]; then
            echo "✓ Found $XOR_COUNT XOR instruction(s)"
          else
            echo "⚠ No XOR instructions found"
          fi
          
          # Verify plaintext is NOT in the binary
          if strings target/release/examples/debug_drop | grep -qE "^(hello|world|secret|leaked)$"; then
            echo "✗ ERROR: Plaintext secrets found in binary!"
            exit 1
          else
            echo "✓ No plaintext secrets found in binary"
          fi
          
          echo "Binary verification complete!"

  miri:
    name: Miri Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: 1.93.1
      - name: Install Miri
        run: |
          rustup component add miri
          cargo miri setup
      - name: Run Miri Tests
        run: cargo miri test
      - name: Run Miri on Examples
        run: cargo miri run --example debug_drop
